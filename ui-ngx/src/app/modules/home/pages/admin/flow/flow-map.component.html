<mat-drawer-container hasBackdrop="false" class="tb-absolute-fill">
  <mat-drawer-content>
    <div class="tb-entity-table tb-absolute-fill">
      <div fxLayout="row" class="tb-entity-table-content tb-outlined-border">
        <div
          fxFlex="16"
          class="tree-container scrollable-container primary-backdrop"
        >
          <mat-form-field appearance="outline">
            <mat-label>Search Type</mat-label>
            <mat-select [(value)]="searchFilter">
              <mat-option value="name">Name</mat-option>
              <mat-option value="prefix">Prefix</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Search Functions</mat-label>
            <input
              matInput
              [(ngModel)]="searchQuery"
              (keyup.enter)="filterNodes()"
              placeholder="Search functions..."
            />
          </mat-form-field>

          <button mat-button (click)="clearSearch()">Clear Search</button>

          <mat-tree
            [dataSource]="functionTreeDataSource"
            [treeControl]="treeControl"
          >
            <mat-nested-tree-node *matTreeNodeDef="let node" matTreeNodePadding>
              <div
                class="mat-tree-node-content hover-pointer"
                (click)="toggleNode(node)"
              >
                <button mat-icon-button matTreeNodeToggle>
                  <mat-icon>
                    {{
                      treeControl.isExpanded(node)
                        ? "expand_more"
                        : "chevron_right"
                    }}
                  </mat-icon>
                </button>
                <span
                  class="mat-tree-node-label"
                  [innerHTML]="highlightText(node.name, searchQuery)"
                ></span>
              </div>
              <div
                class="mat-tree-node-children"
                [class.example-tree-invisible]="!treeControl.isExpanded(node)"
              >
                <ng-container matTreeNodeOutlet></ng-container>
              </div>
            </mat-nested-tree-node>
          </mat-tree>
        </div>

        <div fxFlex="84" class="right-panel-container">
          <div class="button-container">
            <button
              mat-icon-button
              (click)="openAddNewNodeDialog()"
              aria-label="Add New Node"
            >
              <mat-icon>add_circle</mat-icon>
            </button>
            <button
              mat-icon-button
              (click)="openAddFunctionDialog()"
              aria-label="Add Function"
            >
              <mat-icon>functions</mat-icon>
            </button>
            <button
              mat-icon-button
              (click)="execute_flow()"
              aria-label="Execute Flow"
            >
              <mat-icon>play_arrow</mat-icon>
            </button>
            <button
              mat-icon-button
              (click)="openViewExecutionsDialog()"
              aria-label="View Executions"
            >
              <mat-icon>visibility</mat-icon>
            </button>
            <button
              mat-icon-button
              [matMenuTriggerFor]="notebookMenu"
              aria-label="Notebook Actions"
            >
              <mat-icon>book</mat-icon>
            </button>
            <mat-menu #notebookMenu="matMenu">
              <button mat-menu-item (click)="start_notebook()">Start</button>
              <a mat-menu-item href="/notebooks" target="_blank">Open</a>
            </mat-menu>
            <button
              mat-icon-button
              [matMenuTriggerFor]="airflowMenu"
              aria-label="Airflow Actions"
            >
              <mat-icon>autorenew</mat-icon>
            </button>
            <mat-menu #airflowMenu="matMenu">
              <button
                mat-menu-item
                (click)="upload_to_airflow()"
                aria-label="Upload to Airflow"
              >
                <mat-icon>cloud_upload</mat-icon>
              </button>
              <a
                mat-menu-item
                [href]="'http://192.168.0.218:9333/dags/' + flowId + '/grid'"
                target="_blank"
                aria-label="Open Airflow"
              >
                Open
              </a>
            </mat-menu>
            <a mat-icon-button [href]="explorer_url" target="_blank">
              <mat-icon>folder</mat-icon>
            </a>
            <div *ngIf="isLoading">
              <mat-icon>hourglass_empty</mat-icon>
            </div>
          </div>

          <reactflow-wrapper
            [nodes]="nodes"
            [edges]="edges"
            [saveFlow]="saveFlow"
            [openEditingDialogBox]="openEditingDialogBox"
            [onDropNodeToBackend]="onDropNodeToBackend"
            (nodesChange)="onNodesChange($event)"
            (edgesChange)="onEdgesChange($event)"
            (connectionsChange)="onConnect($event)"
            (positionChange)="onPositionChange($event)"
            (onOpenEditingDialogBox)="onOpenEditingDialogBox($event)"
          >
          </reactflow-wrapper>

          <!-- Translucent Function Nodes Overlay -->
          <div class="function-nodes-overlay">
            <div class="function-nodes-header">Function Nodes</div>
            <mat-form-field appearance="outline" class="mb-8">
              <mat-label>Search List</mat-label>
              <input
                matInput
                [(ngModel)]="functionListSearchQuery"
                (keyup.enter)="filterLocalFunctionNodes()"
                placeholder="Filter function nodes..."
              />
            </mat-form-field>
            <button
              mat-stroked-button
              color="primary"
              (click)="clearFunctionListSearch()"
              class="mb-8"
            >
              Clear
            </button>
            <div
              class="function-node"
              *ngFor="let func of filteredFunctions"
              draggable="true"
              (dragstart)="onFunctionDragStart($event, func)"
            >
              <div class="function-node-header">{{ func.name }}</div>
              <div class="function-node-description">
                {{ func.description }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </mat-drawer-content>
</mat-drawer-container>
